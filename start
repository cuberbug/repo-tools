#!/usr/bin/env bash
# ==============================================================================
# Точка входа: start
# ------------------------------------------------------------------------------
# Назначение:
#   Скрипт инициализирует рабочее окружение и запускает главное меню приложения.
#   Он проверяет наличие системных зависимостей, настраивает виртуальное
#   окружение Python и безопасно выполняет целевой скрипт `menu/menu.py`.
#
# Этапы выполнения:
#   1. Подключение вспомогательных библиотек (env.sh, ui.sh, utils.sh)
#   2. Проверка системных зависимостей (Git, Python)
#   3. Настройка виртуального окружения:
#        - создание при отсутствии
#        - обновление зависимостей
#   4. Запуск основного меню
#
# Структура путей:
#   TOOLS_ROOT/                — корень инструментов
#   ├── scripts/env.sh         — предварительная настройка окружения
#   ├── scripts/ui.sh          — оформление вывода
#   ├── scripts/utils.sh       — логика и утилиты
#   ├── apps/requirements.txt  — список зависимостей
#   ├── apps/.venv/            — виртуальное окружение Python
#   └── apps/menu/menu.py      — главный модуль приложения
#
# Возвращаемые значения:
#   0 — успешная инициализация и/или корректное завершение работы
#   1 — при ошибках проверки зависимостей, создания окружения или запуске меню
#
# Пример запуска:
#   ./start
#
# Примечания:
#   - Скрипт безопасен к запуску повторно: при наличии окружения
#     выполняется только проверка и обновление зависимостей.
#   - В режиме ошибок вывод остаётся на экране до нажатия Enter.
#   - Поддерживает флаги --debug и --no-color для управления выводом.
# ==============================================================================


set -o errexit
set -o nounset
set -o pipefail


# === Определение путей и подключение библиотек ===

REPO_TOOLS_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SRC_DIR="$REPO_TOOLS_ROOT/scripts"
# shellcheck source=scripts/ui.sh
source "${SRC_DIR}/ui.sh" || { echo "Ошибка: не найден ui.sh" >&2; exit 1; }
# shellcheck source=scripts/env.sh
source "${SRC_DIR}/env.sh" || { echo "Ошибка: не найден env.sh" >&2; exit 1; }
# shellcheck source=scripts/utils.sh
source "${SRC_DIR}/utils.sh" || { echo "Ошибка: не найден utils.sh" >&2; exit 1; }


# === Основная логика ===

main() {
  local venv_python

  init_format

  show_hello

  init_env

  setup_venv \
    --venv-dir "$VENV_DIR" \
    --python "$VENV_PYTHON_FILE" \
    --pip "$VENV_PIP_FILE" \
    --requirements "$REQUIREMENTS_FILE"

  venv_python="$(choose_python "$VENV_PYTHON_FILE")"

  if confirm "Запустить главное меню"; then
    e_info "Запуск меню..."

    # Переход важен для корректной работы относительных путей внутри python-скриптов
    cd "$REPO_TOOLS_ROOT"

    "$venv_python" -m "$MENU_APP"
  else
    e_stop "$(f_yellow "Запуск меню отменён.")"
    return 0
  fi
}


# === Безопасный запуск ===

parse_args "$@"

if main; then
  exit 0
else
  e_error "$(e_bold "В процессе инициализации произошла ошибка.")"
  e_error "Пожалуйста, просмотрите вывод выше, чтобы понять причину."
  e_error "Окно не будет закрыто автоматически, чтобы вы могли изучить лог."
  read -r -p "Нажмите Enter для выхода..."
  exit 1
fi
