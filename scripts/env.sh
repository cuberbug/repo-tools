#!/usr/bin/env bash
# shellcheck disable=SC2034
set -o errexit
set -o nounset
set -o pipefail

USE_COLOR=1

unset DEBUG
unset USE_COLOR_SET_BY_CLI

unset APPS_DIR
unset REQUIREMENTS_FILE
unset VENV_DIR
unset VENV_PYTHON_FILE
unset VENV_PIP_FILE
unset MENU_APP


# ==============================================================================
# Разбор аргументов командной строки
# ------------------------------------------------------------------------------
# Читает переданные скрипту опции и переопределяет глобальные переменные конфигурации.
#
# Параметры:
#   $@ — все аргументы скрипта
# ==============================================================================
parse_args() {
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      -N|--no-color) USE_COLOR=0; USE_COLOR_SET_BY_CLI=1; shift ;;
      -d|--debug) DEBUG=1; shift ;;
      -h|--help|help) show_help; exit 0 ;;
      -v|--version) echo "v$VERSION"; exit 0 ;;
      -*)
        echo "Неизвестная опция: $1. Используйте --help для справки." >&2
        exit 1
        ;;
      *)
        echo "Ошибка: Скрипт не принимает позиционные аргументы ('$1')." >&2
        exit 1
        ;;
    esac
  done
}


# ==============================================================================
# Имя функции: init_env
# ------------------------------------------------------------------------------
# Инициализирует окружение после проверки системных зависимостей:
#   - Настраивает форматирование выводимого текста
#   - Устанавливает значения для важных переменных
#
# Возвращаемые значения:
#   0 — если все зависимости найдены
#   1 — если отсутствует хотя бы одна зависимость
# ==============================================================================
init_env() {
  e_debug "Запуск инициализации окружения..."

  check_dependencies

  # REPO_TOOLS_ROOT определяется в главном файле `start`
  APPS_DIR="${REPO_TOOLS_ROOT}/apps"

  REQUIREMENTS_FILE="${APPS_DIR}/requirements.txt"
  VENV_DIR="${APPS_DIR}/.venv"
  VENV_PYTHON_FILE="${VENV_DIR}/bin/python"
  VENV_PIP_FILE="${VENV_DIR}/bin/pip"

  MENU_APP="apps.menu.menu"


  e_debug "Переменные окружения подготовлены."
  e_debug "Рабочая директория: $(f_bold "$REPO_TOOLS_ROOT")"
  e_debug "Директория Python-приложений: $(f_bold "$APPS_DIR")"
  e_debug "Директория для установки виртуального окружения: $(f_bold "$VENV_DIR")"
}


# ==============================================================================
# Имя функции: check_dependencies
# ------------------------------------------------------------------------------
# Назначение:
#   Проверяет наличие системных зависимостей (Git и Python).
#
# Возвращаемые значения:
#   0 — если все зависимости найдены
#   1 — если отсутствует хотя бы одна зависимость
# ==============================================================================
check_dependencies() {
  e_info "Проверка системных зависимостей..."
  if ! command -v git &>/dev/null; then
    e_error "Git не найден. Пожалуйста, установите Git."
    return 1
  fi
  if ! command -v python3 &>/dev/null && ! command -v python &>/dev/null; then
    e_error "Python не найден. Пожалуйста, установите Python."
    return 1
  fi
  e_done "Все системные зависимости найдены."
  return 0
}
